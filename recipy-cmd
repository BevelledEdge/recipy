#!/usr/local/bin/python
"""recipy - a frictionless provenance tool for Python

Usage:
  recipy-cmd [options] <outputfile>
  recipy-cmd (-h | --help)
  recipy-cmd --version

Options:
  -h --help     Show this screen
  --version     Show version
  -a --all      Show all results (otherwise just latest result given)
  -v --verbose  Be verbose
  -d --diff     Show diff

"""
from docopt import docopt
from pymongo import MongoClient
import sys
from pprint import pprint

def print_result(r):
    r['environment'] = ",".join(r['environment'])

    if args['--verbose']:
        pprint(r)
    else:
        intro = """Created by {author} on {date}
Ran {command} using {environment}
Inputs:
""".format(**r)

        indented_inputs = map(lambda x: "  "+x, r['inputs'])
        indented_outputs = map(lambda x: "  "+x, r['outputs'])
        inputs = "\n".join(indented_inputs)
        outputs = "\n".join(indented_outputs)

        print intro + inputs + "\nOutputs:\n" + outputs

if __name__ == '__main__':
    args = docopt(__doc__, version='recipy-cmd v0.1')
    print(args)

    filename = args['<outputfile>']

    client = MongoClient()

    db = client.recipyDB

    #Create images collection
    recipies = db.recipies

    results = recipies.find({'outputs':filename}, sort=[('date', -1)])
    if results.count() == 0:
        print "No results found"
    else:
        if args['--all']:
            for r in results:
                print_result(r)
                print "-"*40
        else:
            print_result(results[0])
            if results.count() > 1:
                print "** Previous runs creating this output have been found. Run with --all to show. **"

            if args['--diff']:
                print "\n\n"
                print results[0]['diff']
